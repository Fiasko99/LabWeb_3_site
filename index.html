<!doctype html>
<html>
	<head lang="ru">
		<title>LabWeb_3</title>
		<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<script src="vue.js"></script>
		<script src='axios-master/dist/axios.min.js'></script>
		<script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>

		<link rel=icon href=/favicon.ico>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@1,300&display=swap" rel="stylesheet">
		
		<style>
			* {
				font-family: 'Roboto', sans-serif;
			}
			main {
				min-height: calc(100vh - 112px);
				background-color: seashell;
			}
			footer {
				height: 49px;
				background-color: gainsboro;
			}
			.footer-icon {
				min-height: 32px !important;
			}
			.footer-icon:hover {
				padding: 3px;
			}
			.a-response {
				display: inline-block; 
				position: relative;
			}
			.a-response:hover::after {
				content: attr(data-title);
				position: absolute;
				left: 20%;
				top: -64px;
				z-index: 1; 
				background: rgba(255,255,230,0.9);
				font-size: 12px; 
				padding: 5px 10px; 
				border: 1px solid #333; 
				border-radius: 5px;
			}
			.slide-fade-enter-active {
				transition: all .8s ease;
			}
			.slide-fade-leave-active {
				transition: all .4s cubic-bezier(1.0, 0.5, 0.8, 1.0);
			}
			.slide-fade-enter, .slide-fade-leave-to {
				transform: translateX(50px);
				opacity: 0;
			}
			.elem-li div:hover {
				font-weight: bold;
				cursor: default;
				border: 1px solid gray;
				box-shadow: 0 0 20px rgba(0,0,0,1);
				-webkit-box-shadow: 0 0 20px rgba(0,0,0,1);
				-moz-box-shadow: 0 0 20px rgba(0,0,0,1);
				border-radius: 8px;
				padding: 4px;
			}
			.elem-li div:hover::after {
				content: attr(data-title);
				position: absolute;
				left: 0;
				top: -32px;
				z-index: 1; 
				background: rgba(0,0,0,0.1);
				font-size: 10px; 
				font-weight: bold;
				padding: 5px 10px; 
				border-top-left-radius: 5px;
				border-top-right-radius: 5px;
				border-bottom-left-radius: 5px;
			}
			.c-both {
				clear: both;
			}
			.row .col-6 {
				padding: 5px;
			}
			.exit-btn-location {
				bottom: 49px;
				right: 0;
			}
		</style>
	</head>
	<body>
	
		<div id='myapp'>
			
			<header>
				<nav class="navbar navbar-expand-xl navbar-dark bg-dark">
					<div class="navbar-brand " @click="login = !login;">
					  	<img src="./assets/logo.svg" alt="" class="w-25 img-fluid">
					</div>
					<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"  v-if="login">
					  	<span	span class="navbar-toggler-icon"></span>
					</button>
					<div class="collapse navbar-collapse justify-content-end" id="navbarNavAltMarkup" v-if="login">
						<div class="navbar-nav">
							<router-link class="nav-item nav-link" to="/profile">Профиль</router-link>
							<router-link class="nav-item nav-link" to="/">Файлы</router-link>
							<router-link class="nav-item nav-link" to="/setting">Настройки</router-link>
						</div>
					</div>
				</nav>
			</header>

			<main>
				<div class="container">
					<div v-if="!login">
						<button @click="instruction = !instruction" class="btn btn-info w-100 rounded-0">
							Посмтреть возможности сайта
						</button>
						<transition mode="out-in" name="slide-fade">
							<div v-if="instruction" class="text-info p-2 border-left border-right border-info">
								<p>Функции пользователя: </p>
								<ul>
									<li>загружать файл;</li>
									<li>настраивать доступ к файлу;</li>
									<li>просматривать список доступных файлов;</li>
									<li>удалить файл;</li>
									<li>скрыть/отобразить файл;</li>
									<li>фильтровать файлы;</li>
									<li>скачать файл.</li>
								</ul>
							</div>
						</transition> 
					</div>
					<div class="border border-top-0 border-info p-2 text-center" v-if="!login">
						<h2 class="h2 text-center pb-4">Почему мы?</h2>
						<div class="row elem-li m-4 pb-4">
							<div class="col-6" data-title="Удобнее только у it-гигантов">
								<p>Удобство</p>
								<img src="./assets/conv-ico.svg" alt="" class="w-25">
							</div>
							<div class="col-6" data-title="Данные шифруются">
								<p>Конфиденциальность</p>
								<img src="./assets/confid-ico.svg" alt="" class="w-25">
							</div>
						</div>
						<div class="row elem-li m-4">
							<div class="col-6" data-title="Полный контроль на своими файлами">
								<p>Надёжность</p>
								<img src="./assets/lock-ico.svg" alt="" class="w-25">
							</div>
							<div class="col-6" data-title="Функционал необходимый всем">
								<p>Актуальность</p>
								<img src="./assets/actual-ico.svg" alt="" class="w-25">
							</div>
						</div>
					</div>

					
					<div class="mt-4 text-center" v-if="!login">
						<transition mode="out-in" name="slide-fade">
							<button class="btn btn-primary" @click="uno_auth()" v-if="!formGroup">Войти</button>
							<form v-if="formGroup" class="mt-2">
								<div class="form-group">
								  <label for="login">Login</label>
								  <input type="text" class="form-control" id="login" aria-describedby="loginHelp" value="nif-nif" v-model="userLogin" autocomplete="off">
								  <small id="loginHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>
								</div>
								<div class="form-group">
								  <label for="password">Password</label>
								  <input type="password" class="form-control" id="password" value="wolf" v-model="userPassword" autocomplete="off">
								</div>
								<div class="form-check">
								  <input type="checkbox" class="form-check-input" id="registCheck" v-model="regist">
								  <label class="form-check-label" for="registCheck">Зарегистрироваться</label>
								</div>
								<button type="button" class="btn btn-primary" @click="[auth(), getListFileByUser()]">Вход</button>
							  </form>
						</transition>
					</div>
					<div class="pt-4 text-center" v-if="login">
						<transition mode="out-in" name="slide-fade">
							<button class="btn btn-success float-left" @click="uno_addFile()" v-if="!addFile">Добавить файл</button>
							<div v-if="addFile" >
								<div class="c-both m-2">
									<button class="btn btn-outline-primary" @click="uno_addFile()">Назад</button>
								</div>
								<div class="c-both m-2 form-group text-center">
									<label for="textMessage" class="float-left ml-4 font-weight-bold">Сообщение</label>
									<input type="text" id="textMessage" class="form-control" placeholder="Текст к загружаемому файлу" v-model="textMessage">
								</div>
								<div class="custom-file c-both m-2 p-2" v-if="textMessage">
									<input type="file" id="file" ref="file" v-if="textMessage" @change="handleFileUpload()" class="custom-file-input">
									<label for="file" v-if="textMessage" class="custom-file-label">Выберите файл для передачи</label>
								</div>
								<div class="form-check">
									<input type="checkbox" class="form-check-input" id="privateCheck" v-model="status">
									<label class="form-check-label" for="privateCheck">Сделать приватным</label>
								</div>
								<div class="c-both m-2">
									<button class="btn btn-success" type="button" @click='uploadFile()' v-if="file">Отправить</button>
								</div>
							</div>
						</transition>
					</div>
					<div class="text-center c-both mt-4 pt-4" v-if="login">
						<transition mode="out-in" name="slide-fade">
							<router-view></router-view>
						</transition>
					</div>
					<button class="btn btn-light text-black font-weight-bold position-absolute exit-btn-location rounded-0" @click="reverseLogin()" v-if="login">Выйти из профиля</button>
				</div>
			</main>
			
			<footer>
				<div class="text-center pt-2">
					<!-- GitHub URL: https://github.com/Fiasko99 -->
					<span class="font-weight-bold text-black">GitHub: </span>
					<a href="https://github.com/Fiasko99" target="_blank" data-title="Личный гитхаб автора" class="a-response"><img src="./assets/githubicon.svg" alt="ico" class="footer-icon"></a>
				</div>
			</footer>
			
		</div>

		<!-- Script -->
		<script>
			const profile = {
				template: '<h1>profile</h1>'
			}
			const files = {
				template: `
					<h1 class="test">Files</h1>
				`
			}
			const setting = {
				template: '<h1>setting</h1>'
			}

			const router = new VueRouter({
				routes: [
					{
						path: '/profile',
						component: profile
					},
					{
						path: '/',
						component: files
					},
					{
						path: '/setting',
						component: setting
					}
				]
			})

			var app = new Vue({
				router,
				el: '#myapp',
				data() {
					return {
						instruction: false,

						addFile: false,
						status: false,
						textMessage: '',
						file: '',
						files: [],
						
						formGroup: false,
						login: false,
						regist: false,
						userLogin: '',
						userPassword:'',
						userData: null,
					}
				},
				methods: {
					uno_addFile: function() {
						this.addFile = !this.addFile;
					},
					uno_auth: function() {
						this.formGroup = !this.formGroup;
					},
					auth: function() {
						const self = this;
						if(!this.regist) {
							axios.get('http://localhost:3000/users?login=' + this.userLogin +"&password=" + this.userPassword)
							.then(function(response) {
								this.userData = response.data;								
							})
							.then(function() {
								if (this.userData[0]) {
									if (this.userData[0]['role'] === 3) {
										self.login = !self.login;
									} else {
										alert("Access denied")
									}
								} else {
									alert("Not found");
								}
							})
							.catch(function(error) {
								alert(error);
							});
						} else {
							this.createFolder();
						}
					},
					reverseLogin: function() {
						location.reload()
					},
					handleFileUpload: function() {
						this.file = this.$refs.file.files[0];
					},
					uploadFile: function(){
						let self = this;
						let login = this.userLogin;
						this.file = this.$refs.file.files[0];
						let status = this.status ? "private" : "public";
						
						let formData = new FormData();
						formData.append('file', this.file);

						 axios.post('ajaxfile.php', formData,
						{
						    headers: {
								'Content-Type': 'multipart/form-data',
								'login': login
						    }
						})
						.then(function (response) {
							if(response.data === 0){
								alert('File not uploaded.');
								console.log(response.data);
							}else{
								let file = {
									'id_user': response.data[0]['id'],
									'name_file': self.file.name,
									'status_file': status,
									'text': self.textMessage
								}
								self.post_new_file(file)
								alert('File uploaded.');
							}
						})
						.catch(function (error) {
						    alert(error);
						});
					},
					post_new_file: function(data) {
						axios.post('http://localhost:3000/files', data)
						.then(function(response){
							console.log(response.statusText)
						})
					},
					createFolder: function() {
						let self = this;
						if (self.userLogin !== '') {
							axios({
								method: 'post',
								headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
								url: 'createF.php',
								data: self.userLogin
							})
							.then(function(response) {
								if(response.data === 1) {
									let newUser = {
										'login': self.userLogin,
										'password': self.userPassword,
										'role': 3
									}

									axios.post('http://localhost:3000/users', newUser)
									.then(response => (self.login = response.data))
									.then(function() {
										alert("Пользователь создан");
									});
								} else {
									alert("Пользователь уже существует");
								}
							})
							.catch(function (error) {
								alert(error);
							});
						} else {
							alert("Login field is empty")
						}
					},
					getListFileByUser: function() {
						let self = this;
						console.log(self.UserLogin)
						axios.get(`http://localhost:3000/users?login=${self.UserLogin}&role=3`)
						.then(function(response) {
							self.getFilesById(response.data[0]['id']);
						})
					},
					getFilesById: function(idUser) {
						axios.get(`http://localhost:3000/files?id_user=${idUser}`)
						.then(function(response) {
							console.log(response.data)
						})
					}
				}
			}).$mount('#myapp')

		</script>
		<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
	</body>
</html>
